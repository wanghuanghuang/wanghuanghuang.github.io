---
title: 上传文件临时目录找不到解决方案
date: 2020-04-24 14:12:13
tags:
---

## 1、业务背景
项目很长一段时未做相关布更改和打包发布。最近在上传课程时候，需要下载excel时，发现接口报错500啦。在后端日志目录之中也无法查找到报错信息。仅仅只有前后端分离的前端调用接口的时候返回一个如下错误提示
```
Could not parse multipart servlet request; 
nested exception is java.io.IOException: 
The temporary upload location [/tmp/tomcat/ocalhost/ROOT] is not valid
```

最后我根据错误提示搜索一下，结果发现是tomcat的临时目录被删除了。

(1)SpringBoot项目启动后，系统默认会在 /tmp 目录下自动创建如下三个目录:
```
 hsperfdata_root，
 tomcat.************.8080,(结尾是项目的端后)
 tomcat-docbase.*********.8080
```

(2)Multipart（form-data）的方式处理请求时，默认就是在第二个目录下创建临时文件的

(3)CentOS7 定时清理临时文件目录

/tmp目录的清理规则主要取决于/usr/lib/tmpfiles.d/tmp.conf文件的设定，默认的配置内容为：
```
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

# See tmpfiles.d(5) for details


# Clear tmp directories separately, to make them easier to override
v /tmp 1777 root root 10d  # 10天一清理
v /var/tmp 1777 root root 30d  # 30天一清理

# Exclude namespace mountpoints created with PrivateTmp=yes
x /tmp/systemd-private-%b-*
X /tmp/systemd-private-%b-*/tmp
x /var/tmp/systemd-private-%b-*
X /var/tmp/systemd-private-%b-*/tmp
```

依据以上几条情况，可以看得出我们上传文件的临时目录，在CentOS7之中，会每10天进行定时清理掉。


## 2、三种解决方案
 2.1、直接修改CentOS清理临时目则录规
直接暴力指定不清除所有临时目录，精细化管理针对上传文件tomcat目录不进行清除。
/tmp目录的清理规则主要取决于/usr/lib/tmpfiles.d/tmp.conf文件的设定：
我们可以配置这个文件，比如你不想让系统自动清理/tmp下以tomcat开头的目录，那么增加下面这条内容到配置文件中即可：
```
x /tmp/tomcat.*
```

2.2、通过SpringBoot启动配置注解(@Configuration) 指定自有上传文件目录
         改变临时文件的存储路径，指定自定义非CentOS7的系统默认临时目录，这样就可以避免系统在定时清除临时目录的情况。实现代码如下
```
@Configuration
public class MultipartConfig {
 
    /**
     * 文件上传临时路径
     */
    @Bean
    MultipartConfigElement multipartConfigElement() {
        MultipartConfigFactory factory = new MultipartConfigFactory();
        String location = System.getProperty("user.dir") + "/data/upload/tmp";
        File tmpFile = new File(location);
        if (!tmpFile.exists()) {
            tmpFile.mkdirs();
        }
        factory.setLocation(location);
        return factory.createMultipartConfig();
    }
}
```
2.3、原理类似第二种方案，但是在SpringBoot的配置之中设定Profile信息
在propertites/yaml文件中配置： spring.http.multipart.location= 你的缓存文件路径


更多配置内容参考：[tmpfiles.d 中文手册](http://www.jinbuguo.com/systemd/tmpfiles.d.html)
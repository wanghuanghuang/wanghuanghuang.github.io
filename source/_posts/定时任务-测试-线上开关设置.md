---
title: 定时任务 测试 线上开关设置
date: 2018-12-14 18:17:03
tags:
---


![猫咪老师](/images/页面图片/19.jpg)
今天解决了一个困扰好久的问题，什么问题呢？就是我在项目里写了一个定时任务，每一个小时跑一次并插入数据到数据库，发布到线上了，在每一小时内总是会出现 两条一样的数据 时间仅仅相差几秒，应该是每小时内只出现一条记录。查看线上日志，发现debug日志只打印了一条记录的sql插入记录，怎么找也没有另外一条记录，后面终于知道了，原来是有人连接线上数据库，并开着服务，就导致了数据插入但并未打印线上日志的情况。
为解决这一问题，我们可以设置一个开关，来控制只有在生产环境时才会运行定时任务。
在spring-boot项目里 启动类里 利用@profile注解，该注解可以实现不同环境（开发、测试、部署等）使用不同的配置。
在quartzMain()上指明是application-prod.properties配置文件。
```
@ComponentScan("xxxxxx")
@SpringBootApplication
public class IntelligentCabinetApplication {
    public static void main(String[] args) {
        SpringApplication.run(IntelligentCabinetApplication.class, args);
    }
    
    @Bean
    @Profile({"prod"})
    public QuartzMain quartzMain() {
        return new QuartzMain();
    }

    @Profile({"dev", "test", "test4eureka"})
    @EnableSwagger2
    static class EnableSwaggerSwitch {
    }


}
```
在application.properties配置文件里 声明用的是application-dev.properties 配置文件，所以环境不是prod环境 定时任务自然就不会执行，
在线上可以配置下面文件为prod 。
```
spring.profiles.active=dev
```
